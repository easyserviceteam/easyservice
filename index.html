<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NADRA Fee Tracking System</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
<style>
  body {
    background-color: #f5f7fa;
    color: #2e3a59;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  }
  .container { max-width: 1200px; }
  h1 {
    margin-bottom: 1.5rem;
    font-weight: 700;
    color: #1a2238;
  }
  #formCard {
    background-color: #2c3e50;
    color: #ecf0f1;
  }
  #formCard label,
  #formCard small,
  #formCard .form-control,
  #formCard .form-select,
  #formCard .input-group-text { color: #ecf0f1; }
  #formCard .form-control,
  #formCard .form-select,
  #formCard .input-group-text {
    background-color: #34495e;
    border-color: #4a5a75;
  }
  #formCard .form-control:focus,
  #formCard .form-select:focus {
    background-color: #3b536e;
    border-color: #2980b9;
    color: #ecf0f1;
    box-shadow: none;
  }
  #formCard .btn-primary {
    background-color: #2980b9;
    border-color: #2980b9;
  }
  #formCard .btn-primary:hover {
    background-color: #1c5980;
    border-color: #1c5980;
  }
  .status-section { margin-top: 2rem; }
  .status-section h3 {
    margin-bottom: 0.75rem;
    font-weight: 700;
    color: #1a2238;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .status-section h3 i { font-size: 1.25rem; }
  table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    overflow: hidden;
  }
  thead { background-color: #2980b9; color: white; }
  th, td {
    padding: 0.45rem 0.75rem;
    text-align: left;
    font-size: 0.9rem;
    vertical-align: middle;
    border-bottom: 1px solid #e1e8f0;
    max-width: 150px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  tbody tr:hover { background-color: #d6e9fc; }
  .pending-approval-row { border-left: 4px solid #f39c12; }
  .deficiency-row { border-left: 4px solid #c0392b; }
  .paid-row { border-left: 4px solid #27ae60; }
  .approved-row { border-left: 4px solid #2980b9; }
  .completed-row { border-left: 4px solid #8e44ad; }
  .status-select {
    font-size: 0.85rem;
    padding: 2px 6px;
    border-radius: 4px;
    border: 1px solid #bdc3c7;
    background-color: white;
    cursor: pointer;
    width: 100%;
    color: #34495e;
  }
  .action-btn {
    cursor: pointer;
    color: #7f8c8d;
    transition: color 0.2s;
    margin-left: 6px;
  }
  .action-btn:hover { color: #2980b9; }
  .export-btn {
    font-size: 0.9rem;
    cursor: pointer;
    color: #2980b9;
    background: none;
    border: none;
    padding: 0;
  }
  .export-btn:hover { text-decoration: underline; }
  #summarySection {
    margin-top: 2rem;
    margin-bottom: 3rem;
    display: flex;
    justify-content: center;
    gap: 2rem;
  }
  #summarySection .summary-item {
    background: #ecf0f1;
    border-radius: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    padding: 1rem 2rem;
    text-align: center;
    font-weight: 600;
    color: #34495e;
    min-width: 160px;
  }
  #summarySection .summary-item .count {
    font-size: 2rem;
    font-weight: 700;
    margin-top: 0.25rem;
    color: #2c3e50;
  }
  #tokenSummary {
    margin-top: 2rem;
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  }
  #tokenSummary h3 {
    margin-bottom: 1.5rem;
    font-weight: 700;
    color: #1a2238;
    border-bottom: 2px solid #2980b9;
    padding-bottom: 0.5rem;
  }
  #tokenSummary table {
    box-shadow: none;
  }
  #tokenSummary th {
    background-color: #f8f9fa;
    font-weight: 600;
  }
  .search-container {
    margin-bottom: 1.5rem;
    display: flex;
    gap: 1rem;
  }
  .search-container input {
    flex-grow: 1;
  }
  .search-results {
    margin-top: 1rem;
    background: white;
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  }
  .mark-completed-btn {
    background-color: #8e44ad;
    border-color: #8e44ad;
    color: white;
    padding: 0.25rem 0.5rem;
    font-size: 0.85rem;
    margin-left: 1rem;
  }
  .mark-completed-btn:hover {
    background-color: #7d3c98;
    border-color: #7d3c98;
    color: white;
  }
  @media (max-width: 768px) {
    th, td { font-size: 0.8rem; max-width: 100px; }
    #summarySection {
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }
    .search-container {
      flex-direction: column;
    }
  }
</style>
</head>
<body>
<div class="container py-4">
  <h1 class="text-center">NADRA Fee Tracking System</h1>
  
  <!-- Search Section -->
  <div class="search-container">
    <input type="text" class="form-control" id="searchTrackingId" placeholder="Enter Tracking ID to search..." />
    <button class="btn btn-primary" id="searchBtn">Search</button>
  </div>
  
  <div id="searchResults" class="search-results" style="display: none;">
    <h4>Search Results</h4>
    <div class="table-responsive">
      <table id="searchResultsTable" class="table table-striped table-hover align-middle">
        <thead>
          <tr>
            <th>Tracking ID</th>
            <th>Customer Name</th>
            <th>Contact Number</th>
            <th>Service</th>
            <th>Fee (Rs.)</th>
            <th>Date Added</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Input Form -->
  <div id="formCard" class="card mb-4 shadow-sm text-light">
    <div class="card-header bg-dark">
      <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Add New Transaction</h5>
    </div>
    <div class="card-body">
      <form id="transactionForm" autocomplete="off">
        <div class="row g-3">
          <div class="col-md-4 position-relative">
            <label for="trackingId" class="form-label">Tracking ID</label>
            <input list="trackingIdList" type="text" class="form-control" id="trackingId" required pattern="\d{12}" 
                   title="12-digit NADRA tracking ID" placeholder="e.g. 101195018854" autocomplete="off" />
            <datalist id="trackingIdList"></datalist>
          </div>
          <div class="col-md-4">
            <label for="customerName" class="form-label">Customer Name</label>
            <input type="text" class="form-control" id="customerName" required />
          </div>
          <div class="col-md-4">
            <label for="contactNumber" class="form-label">Contact Number</label>
            <input type="tel" class="form-control" id="contactNumber" required />
          </div>
          <div class="col-md-4">
            <label for="serviceSelect" class="form-label">Select Service</label>
            <select class="form-select" id="serviceSelect" required>
              <option value="" selected disabled>Select service</option>
              <option value="NewCNIC" data-normal="400" data-urgent="1150" data-executive="2150">New CNIC</option>
              <option value="CNICCancellation" data-normal="1420" data-urgent="1420" data-executive="1420">CNIC Cancellation (due to death)</option>
              <option value="NewSmartNIC" data-normal="750" data-urgent="1500" data-executive="2500">New Smart NIC</option>
              <option value="CRC" data-normal="50" data-urgent="500" data-executive="500">CRC</option>
              <option value="FRC" data-normal="1000" data-urgent="1000" data-executive="1000">FRC</option>
              <option value="AgeCase">Age Case</option>
              <option value="Custom">Custom Service</option>
            </select>
          </div>
          <div class="col-md-8" id="customServiceFields">
            <label for="customServiceName" class="form-label">Service Name</label>
            <input type="text" class="form-control" id="customServiceName" placeholder="Enter service name" />
          </div>
          <div class="col-md-4" id="customServiceFieldsFee">
            <label for="customServiceFee" class="form-label">Service Fee</label>
            <div class="input-group">
              <span class="input-group-text">Rs.</span>
              <input type="number" class="form-control" id="customServiceFee" placeholder="Enter fee amount" />
            </div>
          </div>
          <div class="col-md-4" id="ageCaseFields">
            <label class="form-label">Select Age Case Type</label>
            <div>
              <div class="form-check form-check-inline age-case-option">
                <input class="form-check-input" type="radio" name="ageCaseType" id="ageCaseNormal" value="Normal" checked />
                <label class="form-check-label" for="ageCaseNormal">Normal</label>
              </div>
              <div class="form-check form-check-inline age-case-option">
                <input class="form-check-input" type="radio" name="ageCaseType" id="ageCaseExecutive" value="Executive" />
                <label class="form-check-label" for="ageCaseExecutive">Executive</label>
              </div>
            </div>
            <label class="form-label mt-2">Select Age Case Price</label>
            <select class="form-select" id="ageCasePrice">
              <option value="1750">Rs. 1,750 (Normal)</option>
              <option value="2750">Rs. 2,750 (Normal)</option>
              <option value="3750">Rs. 3,750 (Normal)</option>
              <option value="5750">Rs. 5,750 (Normal)</option>
              <option value="3500" class="executive-option">Rs. 3,500 (Executive)</option>
              <option value="4500" class="executive-option">Rs. 4,500 (Executive)</option>
              <option value="5500" class="executive-option">Rs. 5,500 (Executive)</option>
              <option value="7500" class="executive-option">Rs. 7,500 (Executive)</option>
            </select>
          </div>
          <div class="col-md-3" id="feeTypeFields">
            <label for="feeType" class="form-label">Service Type</label>
            <select class="form-select" id="feeType">
              <option value="Normal">Normal</option>
              <option value="Urgent">Urgent</option>
              <option value="Executive">Executive</option>
            </select>
          </div>
          <div class="col-md-3">
            <label for="serviceFee" class="form-label">Service Fee (NADRA)</label>
            <div class="input-group">
              <span class="input-group-text">Rs.</span>
              <input type="number" class="form-control" id="serviceFee" readonly />
            </div>
          </div>
          <div class="col-md-12 text-center mt-3">
            <button type="submit" class="btn btn-primary px-5">
              <i class="fas fa-save me-2"></i>Add Transaction
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Status Sections -->
  <div class="status-section" id="pendingSection">
    <h3>
      <span><i class="fas fa-clock me-2" style="color:#f39c12"></i>Pending Approval</span>
      <button class="export-btn" onclick="exportStatusPDF('Pending Approval')"><i class="fas fa-file-pdf me-1"></i>Export PDF</button>
    </h3>
    <div class="table-responsive">
      <table id="pendingTable" class="table table-striped table-hover align-middle">
        <thead>
          <tr>
            <th>Tracking ID</th>
            <th>Customer Name</th>
            <th>Contact Number</th>
            <th>Service</th>
            <th>Fee (Rs.)</th>
            <th>Date Added</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="status-section" id="approvedSection">
    <h3>
      <span><i class="fas fa-thumbs-up me-2" style="color:#2980b9"></i>Approved</span>
      <button class="export-btn" onclick="exportStatusPDF('Approved')"><i class="fas fa-file-pdf me-1"></i>Export PDF</button>
    </h3>
    <div class="table-responsive">
      <table id="approvedTable" class="table table-striped table-hover align-middle">
        <thead>
          <tr>
            <th>Tracking ID</th>
            <th>Customer Name</th>
            <th>Contact Number</th>
            <th>Service</th>
            <th>Fee (Rs.)</th>
            <th>Date Added</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="status-section" id="deficiencySection">
    <h3>
      <span><i class="fas fa-exclamation-circle me-2" style="color:#c0392b"></i>Deficiency</span>
      <button class="export-btn" onclick="exportStatusPDF('Deficiency')"><i class="fas fa-file-pdf me-1"></i>Export PDF</button>
    </h3>
    <div class="table-responsive">
      <table id="deficiencyTable" class="table table-striped table-hover align-middle">
        <thead>
          <tr>
            <th>Tracking ID</th>
            <th>Customer Name</th>
            <th>Contact Number</th>
            <th>Service</th>
            <th>Fee (Rs.)</th>
            <th>Date Added</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="status-section" id="paidSection">
    <h3>
      <span><i class="fas fa-check-circle me-2" style="color:#27ae60"></i>Paid 
        <button class="mark-completed-btn" id="markAllCompletedBtn">
          <i class="fas fa-check-double me-1"></i>Mark All as Completed
        </button>
      </span>
      <button class="export-btn" onclick="exportStatusPDF('Paid')"><i class="fas fa-file-pdf me-1"></i>Export PDF</button>
    </h3>
    <div class="table-responsive">
      <table id="paidTable" class="table table-striped table-hover align-middle">
        <thead>
          <tr>
            <th>Tracking ID</th>
            <th>Customer Name</th>
            <th>Contact Number</th>
            <th>Service</th>
            <th>Fee (Rs.)</th>
            <th>Date Added</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="status-section" id="completedSection">
    <h3>
      <span><i class="fas fa-archive me-2" style="color:#8e44ad"></i>Completed</span>
      <button class="export-btn" onclick="exportStatusPDF('Completed')"><i class="fas fa-file-pdf me-1"></i>Export PDF</button>
    </h3>
    <div class="table-responsive">
      <table id="completedTable" class="table table-striped table-hover align-middle">
        <thead>
          <tr>
            <th>Tracking ID</th>
            <th>Customer Name</th>
            <th>Contact Number</th>
            <th>Service</th>
            <th>Fee (Rs.)</th>
            <th>Date Paid</th>
            <th>Date Completed</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- Summary Section -->
  <div id="summarySection" class="row g-3 justify-content-center mt-5">
    <div class="col-md-2 summary-item">
      Pending Approval
      <div id="pendingCount" class="count">0</div>
    </div>
    <div class="col-md-2 summary-item">
      Approved
      <div id="approvedCount" class="count">0</div>
    </div>
    <div class="col-md-2 summary-item">
      Deficiency
      <div id="deficiencyCount" class="count">0</div>
    </div>
    <div class="col-md-2 summary-item">
      Paid
      <div id="paidCount" class="count">0</div>
    </div>
    <div class="col-md-2 summary-item">
      Completed
      <div id="completedCount" class="count">0</div>
    </div>
  </div>

  <!-- Token Summary Section -->
  <div id="tokenSummary">
    <h3><i class="fas fa-chart-pie me-2"></i>Service Token Summary</h3>
    <div class="table-responsive">
      <table id="tokenSummaryTable" class="table table-striped table-hover align-middle">
        <thead>
          <tr>
            <th>Service Type</th>
            <th>Pending Approval</th>
            <th>Approved</th>
            <th>Deficiency</th>
            <th>Paid</th>
            <th>Completed</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- Update Modal -->
<div class="modal fade" id="updateModal" tabindex="-1" aria-labelledby="updateModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <form id="updateForm" autocomplete="off">
        <div class="modal-header">
          <h5 class="modal-title" id="updateModalLabel"><i class="fas fa-edit me-2"></i>Update Transaction</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="updateId" />
          <div class="row g-3">
            <div class="col-md-4">
              <label for="updateTrackingId" class="form-label">Tracking ID</label>
              <input type="text" class="form-control" id="updateTrackingId" required pattern="\d{12}" />
            </div>
            <div class="col-md-4">
              <label for="updateCustomerName" class="form-label">Customer Name</label>
              <input type="text" class="form-control" id="updateCustomerName" required />
            </div>
            <div class="col-md-4">
              <label for="updateContactNumber" class="form-label">Contact Number</label>
              <input type="tel" class="form-control" id="updateContactNumber" required />
            </div>
            <div class="col-md-4">
              <label for="updateServiceSelect" class="form-label">Select Service</label>
              <select class="form-select" id="updateServiceSelect" required>
                <option value="" disabled>Select service</option>
                <option value="NewCNIC" data-normal="400" data-urgent="1150" data-executive="2150">New CNIC</option>
                <option value="CNICCancellation" data-normal="1420" data-urgent="1420" data-executive="1420">CNIC Cancellation (due to death)</option>
                <option value="NewSmartNIC" data-normal="750" data-urgent="1500" data-executive="2500">New Smart NIC</option>
                <option value="CRC" data-normal="50" data-urgent="500" data-executive="500">CRC</option>
                <option value="FRC" data-normal="1000" data-urgent="1000" data-executive="1000">FRC</option>
                <option value="AgeCase">Age Case</option>
                <option value="Custom">Custom Service</option>
              </select>
            </div>
            <div class="col-md-8" id="updateCustomServiceFields">
              <label for="updateCustomServiceName" class="form-label">Service Name</label>
              <input type="text" class="form-control" id="updateCustomServiceName" placeholder="Enter service name" />
            </div>
            <div class="col-md-4" id="updateCustomServiceFieldsFee">
              <label for="updateCustomServiceFee" class="form-label">Service Fee</label>
              <div class="input-group">
                <span class="input-group-text">Rs.</span>
                <input type="number" class="form-control" id="updateCustomServiceFee" placeholder="Enter fee amount" />
              </div>
            </div>
            <div class="col-md-4" id="updateAgeCaseFields">
              <label class="form-label">Select Age Case Type</label>
              <div>
                <div class="form-check form-check-inline update-age-case-option">
                  <input class="form-check-input" type="radio" name="updateAgeCaseType" id="updateAgeCaseNormal" value="Normal" checked />
                  <label class="form-check-label" for="updateAgeCaseNormal">Normal</label>
                </div>
                <div class="form-check form-check-inline update-age-case-option">
                  <input class="form-check-input" type="radio" name="updateAgeCaseType" id="updateAgeCaseExecutive" value="Executive" />
                  <label class="form-check-label" for="updateAgeCaseExecutive">Executive</label>
                </div>
              </div>
              <label class="form-label mt-2">Select Age Case Price</label>
              <select class="form-select" id="updateAgeCasePrice">
                <option value="1750">Rs. 1,750 (Normal)</option>
                <option value="2750">Rs. 2,750 (Normal)</option>
                <option value="3750">Rs. 3,750 (Normal)</option>
                <option value="5750">Rs. 5,750 (Normal)</option>
                <option value="3500" class="update-executive-option">Rs. 3,500 (Executive)</option>
                <option value="4500" class="update-executive-option">Rs. 4,500 (Executive)</option>
                <option value="5500" class="update-executive-option">Rs. 5,500 (Executive)</option>
                <option value="7500" class="update-executive-option">Rs. 7,500 (Executive)</option>
              </select>
            </div>
            <div class="col-md-3" id="updateFeeTypeFields">
              <label for="updateFeeType" class="form-label">Service Type</label>
              <select class="form-select" id="updateFeeType">
                <option value="Normal">Normal</option>
                <option value="Urgent">Urgent</option>
                <option value="Executive">Executive</option>
              </select>
            </div>
            <div class="col-md-3">
              <label for="updateServiceFee" class="form-label">Service Fee (NADRA)</label>
              <div class="input-group">
                <span class="input-group-text">Rs.</span>
                <input type="number" class="form-control" id="updateServiceFee" readonly />
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary"><i class="fas fa-save me-2"></i>Save Changes</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Bootstrap & jsPDF scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<script>
const { jsPDF } = window.jspdf;

let dbInstance = null;
let updateModal = null;

document.addEventListener('DOMContentLoaded', () => {
  initDB().then(() => {
    loadTransactions();
    populateTrackingIdList();
  });

  document.getElementById('transactionForm').addEventListener('submit', addTransaction);
  document.getElementById('serviceSelect').addEventListener('change', updateServiceFields);
  document.querySelectorAll('input[name="ageCaseType"]').forEach(radio => {
    radio.addEventListener('change', updateAgeCaseOptions);
  });
  document.getElementById('feeType').addEventListener('change', calculateTotal);
  document.getElementById('ageCasePrice').addEventListener('change', calculateTotal);
  document.getElementById('customServiceFee').addEventListener('input', calculateTotal);

  updateServiceFields();

  updateModal = new bootstrap.Modal(document.getElementById('updateModal'));
  document.getElementById('updateServiceSelect').addEventListener('change', updateUpdateServiceFields);
  document.querySelectorAll('input[name="updateAgeCaseType"]').forEach(radio => {
    radio.addEventListener('change', updateUpdateAgeCaseOptions);
  });
  document.getElementById('updateFeeType').addEventListener('change', updateCalculateTotal);
  document.getElementById('updateAgeCasePrice').addEventListener('change', updateCalculateTotal);
  document.getElementById('updateCustomServiceFee').addEventListener('input', updateCalculateTotal);
  document.getElementById('updateForm').addEventListener('submit', saveUpdatedTransaction);
  document.getElementById('trackingId').addEventListener('input', populateTrackingIdList);
  
  // Search functionality
  document.getElementById('searchBtn').addEventListener('click', searchTransactions);
  document.getElementById('searchTrackingId').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') searchTransactions();
  });
  
  // Mark all as completed button
  document.getElementById('markAllCompletedBtn').addEventListener('click', markAllPaidAsCompleted);
});

function initDB() {
  return new Promise((resolve, reject) => {
    const request = indexedDB.open('NADRATransactionDB', 2); // Version 2 for new schema

    request.onerror = (event) => {
      console.error('Database error:', event.target.error);
      reject(event.target.error);
    };

    request.onupgradeneeded = (event) => {
      const db = event.target.result;
      const oldVersion = event.oldVersion;
      
      if (oldVersion < 1) {
        // Initial creation
        const store = db.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
        store.createIndex('trackingId', 'trackingId', { unique: true });
        store.createIndex('status', 'status', { unique: false });
        store.createIndex('date', 'date', { unique: false });
        store.createIndex('serviceName', 'serviceName', { unique: false });
      }
      
      if (oldVersion < 2) {
        // Upgrade to version 2 - add completedDate field
        const transaction = event.target.transaction;
        const store = transaction.objectStore('transactions');
        
        // Add new index for completed status
        store.createIndex('completed', 'completed', { unique: false });
        store.createIndex('completedDate', 'completedDate', { unique: false });
      }
    };

    request.onsuccess = (event) => {
      dbInstance = event.target.result;
      resolve(dbInstance);
    };
  });
}

async function getAllTransactions(includeCompleted = true) {
  if (!dbInstance) return [];
  return new Promise((resolve, reject) => {
    const transaction = dbInstance.transaction(['transactions'], 'readonly');
    const store = transaction.objectStore('transactions');
    const index = store.index('date');
    const request = index.getAll();

    request.onsuccess = () => {
      let results = request.result;
      if (!includeCompleted) {
        results = results.filter(t => !t.completed);
      }
      resolve(results);
    };
    request.onerror = (e) => reject(e.target.error);
  });
}

async function addTransaction(event) {
  event.preventDefault();

  if (!dbInstance) {
    return;
  }

  const store = dbInstance.transaction(['transactions'], 'readwrite').objectStore('transactions');

  const trackingId = document.getElementById('trackingId').value.trim();
  const customerName = document.getElementById('customerName').value.trim();
  const contactNumber = document.getElementById('contactNumber').value.trim();
  const serviceSelect = document.getElementById('serviceSelect');
  const selectedService = serviceSelect.value;

  let serviceName = serviceSelect.options[serviceSelect.selectedIndex].text;
  let serviceFee = 0;

  if (selectedService === 'Custom') {
    serviceName = document.getElementById('customServiceName').value.trim() || serviceName;
    serviceFee = parseInt(document.getElementById('customServiceFee').value) || 0;
  } else if (selectedService === 'AgeCase') {
    const ageCaseType = document.querySelector('input[name="ageCaseType"]:checked').value;
    serviceName = `Age Case (${ageCaseType})`;
    serviceFee = parseInt(document.getElementById('ageCasePrice').value) || 0;
  } else {
    const feeType = document.getElementById('feeType').value;
    const feeAttribute = `data-${feeType.toLowerCase()}`;
    serviceFee = parseInt(serviceSelect.options[serviceSelect.selectedIndex].getAttribute(feeAttribute)) || 0;
    serviceName = `${serviceName} (${feeType})`;
  }

  const transactionData = {
    trackingId,
    customerName,
    contactNumber,
    serviceName,
    serviceFee: serviceFee,
    status: 'Pending Approval',
    date: new Date().toISOString(),
    completed: false
  };

  try {
    await addToDB(store, transactionData);
    document.getElementById('transactionForm').reset();
    updateServiceFields();
    loadTransactions();
    populateTrackingIdList();
  } catch (error) {
    console.error(error);
  }
}

function addToDB(store, data) {
  return new Promise((resolve, reject) => {
    const request = store.add(data);
    request.onsuccess = () => resolve();
    request.onerror = (event) => reject(event.target.error);
  });
}

async function loadTransactions() {
  if (!dbInstance) return;

  const transactions = await getAllTransactions();
  displayTransactions(transactions);
  populateTrackingIdList();
  updateSummary(transactions);
  updateTokenSummary(transactions);
}

function displayTransactions(transactions) {
  const pendingBody = document.querySelector('#pendingTable tbody');
  const deficiencyBody = document.querySelector('#deficiencyTable tbody');
  const paidBody = document.querySelector('#paidTable tbody');
  const approvedBody = document.querySelector('#approvedTable tbody');
  const completedBody = document.querySelector('#completedTable tbody');

  pendingBody.innerHTML = '';
  deficiencyBody.innerHTML = '';
  paidBody.innerHTML = '';
  approvedBody.innerHTML = '';
  completedBody.innerHTML = '';

  if (transactions.length === 0) {
    const noDataRow = `<tr><td colspan="8" class="text-center text-muted">No transactions found</td></tr>`;
    pendingBody.innerHTML = noDataRow;
    deficiencyBody.innerHTML = noDataRow;
    paidBody.innerHTML = noDataRow;
    approvedBody.innerHTML = noDataRow;
    completedBody.innerHTML = noDataRow;
    return;
  }

  transactions.sort((a, b) => new Date(b.date) - new Date(a.date));

  transactions.forEach(transaction => {
    if (transaction.completed) {
      const row = createCompletedTransactionRow(transaction);
      completedBody.appendChild(row);
    } else {
      const row = createTransactionRow(transaction);
      switch (transaction.status) {
        case 'Pending Approval':
          pendingBody.appendChild(row);
          break;
        case 'Deficiency':
          deficiencyBody.appendChild(row);
          break;
        case 'Paid':
          paidBody.appendChild(row);
          break;
        case 'Approved':
          approvedBody.appendChild(row);
          break;
        default:
          pendingBody.appendChild(row);
          break;
      }
    }
  });
}

function createTransactionRow(transaction) {
  const tr = document.createElement('tr');
  tr.className = transaction.status.toLowerCase().replace(' ', '-') + '-row';

  const dateObj = new Date(transaction.date);
  const formattedDate = dateObj.toLocaleDateString() + ' ' + dateObj.toLocaleTimeString();

  tr.innerHTML = `
    <td title="${transaction.trackingId}">${transaction.trackingId}</td>
    <td title="${transaction.customerName}">${transaction.customerName}</td>
    <td title="${transaction.contactNumber}">${transaction.contactNumber}</td>
    <td title="${transaction.serviceName}">${transaction.serviceName}</td>
    <td>${transaction.serviceFee.toLocaleString()}</td>
    <td title="${formattedDate}">${formattedDate}</td>
    <td></td>
    <td class="text-center">
      <i class="fas fa-copy action-btn copy-btn" title="Copy details"
         data-tracking="${transaction.trackingId}" 
         data-name="${transaction.customerName}" 
         data-contact="${transaction.contactNumber}"
         data-service="${transaction.serviceName}"
         data-fee="${transaction.serviceFee}"></i>
      <i class="fas fa-edit action-btn update-btn" title="Update transaction"></i>
      <i class="fas fa-trash action-btn delete-btn text-danger" title="Delete transaction"></i>
    </td>
  `;

  // Status dropdown in 7th cell
  const statusCell = tr.querySelector('td:nth-child(7)');
  const statusSelect = document.createElement('select');
  statusSelect.className = 'status-select';
  
  const statuses = ['Pending Approval', 'Approved', 'Deficiency', 'Paid'];
  if (transaction.status === 'Paid') {
    statuses.push('Completed');
  }
  
  statuses.forEach(status => {
    const option = document.createElement('option');
    option.value = status;
    option.textContent = status;
    if (transaction.status === status) option.selected = true;
    statusSelect.appendChild(option);
  });
  
  statusSelect.addEventListener('change', () => updateTransactionStatus(transaction.id, statusSelect.value));
  statusCell.appendChild(statusSelect);

  // Copy button event
  const copyBtn = tr.querySelector('.copy-btn');
  copyBtn.addEventListener('click', e => {
    copyToClipboard(e);
    showCopyFeedback(copyBtn);
  });

  // Update button event
  tr.querySelector('.update-btn').addEventListener('click', () => openUpdateModal(transaction));

  // Delete button event
  tr.querySelector('.delete-btn').addEventListener('click', () => deleteTransaction(transaction.id));

  return tr;
}

function createCompletedTransactionRow(transaction) {
  const tr = document.createElement('tr');
  tr.className = 'completed-row';

  const dateObj = new Date(transaction.date);
  const formattedDate = dateObj.toLocaleDateString() + ' ' + dateObj.toLocaleTimeString();
  
  const paidDateObj = transaction.paidDate ? new Date(transaction.paidDate) : dateObj;
  const formattedPaidDate = paidDateObj.toLocaleDateString() + ' ' + paidDateObj.toLocaleTimeString();
  
  const completedDateObj = transaction.completedDate ? new Date(transaction.completedDate) : new Date();
  const formattedCompletedDate = completedDateObj.toLocaleDateString() + ' ' + completedDateObj.toLocaleTimeString();

  tr.innerHTML = `
    <td title="${transaction.trackingId}">${transaction.trackingId}</td>
    <td title="${transaction.customerName}">${transaction.customerName}</td>
    <td title="${transaction.contactNumber}">${transaction.contactNumber}</td>
    <td title="${transaction.serviceName}">${transaction.serviceName}</td>
    <td>${transaction.serviceFee.toLocaleString()}</td>
    <td title="${formattedPaidDate}">${formattedPaidDate}</td>
    <td title="${formattedCompletedDate}">${formattedCompletedDate}</td>
    <td class="text-center">
      <i class="fas fa-copy action-btn copy-btn" title="Copy details"
         data-tracking="${transaction.trackingId}" 
         data-name="${transaction.customerName}" 
         data-contact="${transaction.contactNumber}"
         data-service="${transaction.serviceName}"
         data-fee="${transaction.serviceFee}"></i>
    </td>
  `;

  // Copy button event
  const copyBtn = tr.querySelector('.copy-btn');
  copyBtn.addEventListener('click', e => {
    copyToClipboard(e);
    showCopyFeedback(copyBtn);
  });

  return tr;
}

function showCopyFeedback(icon) {
  const originalTitle = icon.title;
  const originalColor = icon.style.color;
  icon.title = 'Copied!';
  icon.style.color = '#2980b9';
  setTimeout(() => {
    icon.title = originalTitle;
    icon.style.color = originalColor;
  }, 1200);
}

function copyToClipboard(e) {
  e.stopPropagation();

  const trackingId = e.target.dataset.tracking;
  const name = e.target.dataset.name;
  const contact = e.target.dataset.contact;
  const service = e.target.dataset.service;
  const fee = e.target.dataset.fee;

  const text = `Tracking ID: ${trackingId}\nName: ${name}\nContact: ${contact}\nService: ${service}\nFee: Rs. ${fee}`;

  navigator.clipboard.writeText(text).catch(err => {
    console.error('Failed to copy:', err);
  });
}

async function updateTransactionStatus(id, newStatus) {
  if (!dbInstance) return;

  const transaction = dbInstance.transaction(['transactions'], 'readwrite');
  const store = transaction.objectStore('transactions');

  const getRequest = store.get(Number(id));

  getRequest.onsuccess = () => {
    const transactionData = getRequest.result;
    if (!transactionData) return;

    if (newStatus === 'Completed') {
      transactionData.completed = true;
      transactionData.completedDate = new Date().toISOString();
      if (!transactionData.paidDate && transactionData.status === 'Paid') {
        transactionData.paidDate = transactionData.date;
      }
    } else if (newStatus === 'Paid') {
      transactionData.paidDate = new Date().toISOString();
    }
    
    transactionData.status = newStatus;

    const updateRequest = store.put(transactionData);

    updateRequest.onsuccess = () => {
      loadTransactions();
    };

    updateRequest.onerror = (event) => {
      console.error('Error updating transaction status:', event.target.error);
    };
  };

  getRequest.onerror = (event) => {
    console.error('Error fetching transaction for status update:', event.target.error);
  };
}

async function markAllPaidAsCompleted() {
  if (!dbInstance) return;

  const transaction = dbInstance.transaction(['transactions'], 'readwrite');
  const store = transaction.objectStore('transactions');
  const index = store.index('status');
  const request = index.getAll('Paid');

  request.onsuccess = async () => {
    const paidTransactions = request.result.filter(t => !t.completed);
    if (paidTransactions.length === 0) {
      alert('No unpaid transactions found');
      return;
    }

    if (!confirm(`Mark ${paidTransactions.length} paid transactions as completed?`)) {
      return;
    }

    const completedDate = new Date().toISOString();
    
    for (const t of paidTransactions) {
      t.completed = true;
      t.completedDate = completedDate;
      if (!t.paidDate) {
        t.paidDate = t.date;
      }
      
      await new Promise((resolve, reject) => {
        const updateRequest = store.put(t);
        updateRequest.onsuccess = () => resolve();
        updateRequest.onerror = (e) => reject(e.target.error);
      });
    }

    loadTransactions();
  };

  request.onerror = (event) => {
    console.error('Error fetching paid transactions:', event.target.error);
  };
}

async function deleteTransaction(id) {
  if (!dbInstance) return;

  const transaction = dbInstance.transaction(['transactions'], 'readwrite');
  const store = transaction.objectStore('transactions');

  const deleteRequest = store.delete(Number(id));

  deleteRequest.onsuccess = () => {
    loadTransactions();
    populateTrackingIdList();
  };

  deleteRequest.onerror = (event) => {
    console.error('Error deleting transaction:', event.target.error);
  };
}

// Update Modal Logic
function openUpdateModal(transaction) {
  document.getElementById('updateId').value = transaction.id;
  document.getElementById('updateTrackingId').value = transaction.trackingId;
  document.getElementById('updateCustomerName').value = transaction.customerName;
  document.getElementById('updateContactNumber').value = transaction.contactNumber;

  const serviceSelect = document.getElementById('updateServiceSelect');
  serviceSelect.value = '';
  for(let i=0; i < serviceSelect.options.length; i++) {
    if(transaction.serviceName.startsWith(serviceSelect.options[i].text)) {
      serviceSelect.value = serviceSelect.options[i].value;
      break;
    }
  }
  if(!serviceSelect.value) serviceSelect.value = 'Custom';

  updateUpdateServiceFields();

  if(transaction.serviceName.startsWith('Age Case')) {
    const ageType = transaction.serviceName.includes('Executive') ? 'Executive' : 'Normal';
    document.querySelector(`input[name="updateAgeCaseType"][value="${ageType}"]`).checked = true;
    updateUpdateAgeCaseOptions();
    document.getElementById('updateAgeCasePrice').value = transaction.serviceFee || 0;
  } else if(serviceSelect.value === 'Custom') {
    document.getElementById('updateCustomServiceName').value = transaction.serviceName;
    document.getElementById('updateCustomServiceFee').value = transaction.serviceFee || 0;
  } else {
    const suffix = transaction.serviceName.match(/\(([^)]+)\)$/);
    if(suffix && ['Normal','Urgent','Executive'].includes(suffix[1])) {
      document.getElementById('updateFeeType').value = suffix[1];
    } else {
      document.getElementById('updateFeeType').value = 'Normal';
    }
  }

  updateCalculateTotal();

  updateModal.show();
}

function updateUpdateServiceFields() {
  const serviceSelect = document.getElementById('updateServiceSelect');
  const selectedService = serviceSelect.value;

  const customFields = document.getElementById('updateCustomServiceFields');
  const customFeeField = document.getElementById('updateCustomServiceFieldsFee');
  const ageCaseFields = document.getElementById('updateAgeCaseFields');
  const feeTypeFields = document.getElementById('updateFeeTypeFields');

  customFields.style.display = 'none';
  customFeeField.style.display = 'none';
  ageCaseFields.style.display = 'none';
  feeTypeFields.style.display = 'none';

  if (selectedService === 'Custom') {
    customFields.style.display = 'block';
    customFeeField.style.display = 'block';
    feeTypeFields.style.display = 'block';
  } else if (selectedService === 'AgeCase') {
    ageCaseFields.style.display = 'block';
  } else if (selectedService) {
    feeTypeFields.style.display = 'block';
  }
}

function updateUpdateAgeCaseOptions() {
  const ageCaseType = document.querySelector('input[name="updateAgeCaseType"]:checked').value;
  const ageCasePriceSelect = document.getElementById('updateAgeCasePrice');

  if (ageCaseType === 'Executive') {
    document.querySelectorAll('.update-executive-option').forEach(option => {
      option.style.display = 'block';
    });
    const firstExec = ageCasePriceSelect.querySelector('.update-executive-option');
    if (firstExec) firstExec.selected = true;
  } else {
    document.querySelectorAll('.update-executive-option').forEach(option => {
      option.style.display = 'none';
    });
    const firstNormal = ageCasePriceSelect.querySelector('option:not(.update-executive-option)');
    if (firstNormal) firstNormal.selected = true;
  }
}

function updateCalculateTotal() {
  const serviceSelect = document.getElementById('updateServiceSelect');
  const selectedService = serviceSelect.value;
  let serviceFee = 0;

  if (selectedService === 'Custom') {
    serviceFee = parseInt(document.getElementById('updateCustomServiceFee').value) || 0;
  } else if (selectedService === 'AgeCase') {
    serviceFee = parseInt(document.getElementById('updateAgeCasePrice').value) || 0;
  } else if (selectedService) {
    const feeType = document.getElementById('updateFeeType').value.toLowerCase();
    const feeAttribute = `data-${feeType}`;
    const option = Array.from(serviceSelect.options).find(opt => opt.value === selectedService);
    serviceFee = option ? parseInt(option.getAttribute(feeAttribute)) || 0 : 0;
  }

  document.getElementById('updateServiceFee').value = serviceFee;
}

async function saveUpdatedTransaction(event) {
  event.preventDefault();

  if (!dbInstance) {
    return;
  }

  const id = parseInt(document.getElementById('updateId').value);
  const trackingId = document.getElementById('updateTrackingId').value.trim();
  const customerName = document.getElementById('updateCustomerName').value.trim();
  const contactNumber = document.getElementById('updateContactNumber').value.trim();
  const serviceSelect = document.getElementById('updateServiceSelect');
  const selectedService = serviceSelect.value;

  let serviceName = serviceSelect.options[serviceSelect.selectedIndex].text;
  let serviceFee = 0;

  if (selectedService === 'Custom') {
    serviceName = document.getElementById('updateCustomServiceName').value.trim() || serviceName;
    serviceFee = parseInt(document.getElementById('updateCustomServiceFee').value) || 0;
  } else if (selectedService === 'AgeCase') {
    const ageCaseType = document.querySelector('input[name="updateAgeCaseType"]:checked').value;
    serviceName = `Age Case (${ageCaseType})`;
    serviceFee = parseInt(document.getElementById('updateAgeCasePrice').value) || 0;
  } else {
    const feeType = document.getElementById('updateFeeType').value;
    const feeAttribute = `data-${feeType.toLowerCase()}`;
    serviceFee = parseInt(serviceSelect.options[serviceSelect.selectedIndex].getAttribute(feeAttribute)) || 0;
    serviceName = `${serviceName} (${feeType})`;
  }

  const transactionData = {
    id,
    trackingId,
    customerName,
    contactNumber,
    serviceName,
    serviceFee: serviceFee,
    status: 'Pending Approval',
    date: new Date().toISOString(),
    completed: false
  };

  try {
    await updateDB(transactionData);
    updateModal.hide();
    loadTransactions();
    populateTrackingIdList();
  } catch (error) {
    console.error(error);
  }
}

function updateDB(data) {
  return new Promise((resolve, reject) => {
    const transaction = dbInstance.transaction(['transactions'], 'readwrite');
    const store = transaction.objectStore('transactions');
    const request = store.put(data);
    request.onsuccess = () => resolve();
    request.onerror = (event) => reject(event.target.error);
  });
}

async function populateTrackingIdList() {
  if (!dbInstance) return;

  const allTransactions = await getAllTransactions();
  const uniqueTrackingIds = [...new Set(allTransactions.map(t => t.trackingId))].sort();

  const datalist = document.getElementById('trackingIdList');
  datalist.innerHTML = '';
  uniqueTrackingIds.forEach(id => {
    const option = document.createElement('option');
    option.value = id;
    datalist.appendChild(option);
  });
}

async function searchTransactions() {
  const trackingId = document.getElementById('searchTrackingId').value.trim();
  if (!trackingId) return;

  if (!dbInstance) {
    alert('Database not initialized');
    return;
  }

  const transaction = dbInstance.transaction(['transactions'], 'readonly');
  const store = transaction.objectStore('transactions');
  const index = store.index('trackingId');
  const request = index.getAll(trackingId);

  request.onsuccess = () => {
    const results = request.result;
    const searchResults = document.getElementById('searchResults');
    const searchResultsTable = document.querySelector('#searchResultsTable tbody');
    
    searchResultsTable.innerHTML = '';
    
    if (results.length === 0) {
      searchResultsTable.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No transactions found with this Tracking ID</td></tr>';
    } else {
      results.forEach(transaction => {
        const dateObj = new Date(transaction.date);
        const formattedDate = dateObj.toLocaleDateString() + ' ' + dateObj.toLocaleTimeString();
        
        let paidDate = 'N/A';
        if (transaction.paidDate) {
          const paidDateObj = new Date(transaction.paidDate);
          paidDate = paidDateObj.toLocaleDateString() + ' ' + paidDateObj.toLocaleTimeString();
        }
        
        let completedDate = 'N/A';
        if (transaction.completedDate) {
          const completedDateObj = new Date(transaction.completedDate);
          completedDate = completedDateObj.toLocaleDateString() + ' ' + completedDateObj.toLocaleTimeString();
        }
        
        const status = transaction.completed ? 'Completed' : transaction.status;
        
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${transaction.trackingId}</td>
          <td>${transaction.customerName}</td>
          <td>${transaction.contactNumber}</td>
          <td>${transaction.serviceName}</td>
          <td>${transaction.serviceFee.toLocaleString()}</td>
          <td>${formattedDate}</td>
          <td>${status}</td>
        `;
        searchResultsTable.appendChild(row);
      });
    }
    
    searchResults.style.display = 'block';
  };

  request.onerror = (event) => {
    console.error('Error searching transactions:', event.target.error);
    alert('Error searching transactions');
  };
}

async function exportStatusPDF(status) {
  if (!dbInstance) return;

  const transactions = await getAllTransactions(status === 'Completed');
  let filtered = transactions;
  
  if (status !== 'Completed') {
    filtered = transactions.filter(t => t.status === status && !t.completed);
  } else {
    filtered = transactions.filter(t => t.completed);
  }

  if (filtered.length === 0) {
    alert(`No ${status} transactions found`);
    return;
  }

  const doc = new jsPDF();
  doc.setFontSize(16);
  doc.text(`NADRA Fee Tracking System - ${status} Transactions`, 14, 22);

  const columns = [
    { header: 'Tracking ID', dataKey: 'trackingId' },
    { header: 'Customer Name', dataKey: 'customerName' },
    { header: 'Contact Number', dataKey: 'contactNumber' },
    { header: 'Service', dataKey: 'serviceName' },
    { header: 'Fee (Rs.)', dataKey: 'serviceFee' },
    { header: 'Date Added', dataKey: 'date' }
  ];

  if (status === 'Completed') {
    columns.push({ header: 'Date Completed', dataKey: 'completedDate' });
  }

  const rows = filtered.map(t => {
    const row = {
      trackingId: t.trackingId,
      customerName: t.customerName,
      contactNumber: t.contactNumber,
      serviceName: t.serviceName,
      serviceFee: t.serviceFee.toLocaleString(),
      date: new Date(t.date).toLocaleString()
    };
    
    if (status === 'Completed') {
      row.completedDate = t.completedDate ? new Date(t.completedDate).toLocaleString() : 'N/A';
    }
    
    return row;
  });

  doc.autoTable({
    startY: 30,
    columns,
    body: rows,
    styles: { fontSize: 8 },
    headStyles: { fillColor: [41, 128, 185] }
  });

  doc.save(`NADRA_${status.replace(/\s/g, '_')}_Transactions.pdf`);
}

function updateSummary(transactions) {
  const summary = {
    'Pending Approval': 0,
    'Approved': 0,
    'Deficiency': 0,
    'Paid': 0,
    'Completed': 0
  };

  transactions.forEach(t => {
    if (t.completed) {
      summary['Completed']++;
    } else if (summary.hasOwnProperty(t.status)) {
      summary[t.status]++;
    }
  });

  document.getElementById('pendingCount').textContent = summary['Pending Approval'];
  document.getElementById('approvedCount').textContent = summary['Approved'];
  document.getElementById('deficiencyCount').textContent = summary['Deficiency'];
  document.getElementById('paidCount').textContent = summary['Paid'];
  document.getElementById('completedCount').textContent = summary['Completed'];
}

function updateTokenSummary(transactions) {
  const serviceSummary = {};
  const statuses = ['Pending Approval', 'Approved', 'Deficiency', 'Paid', 'Completed'];
  
  // Initialize service summary
  transactions.forEach(t => {
    if (!serviceSummary[t.serviceName]) {
      serviceSummary[t.serviceName] = {
        'Pending Approval': 0,
        'Approved': 0,
        'Deficiency': 0,
        'Paid': 0,
        'Completed': 0,
        'Total': 0
      };
    }
    
    if (t.completed) {
      serviceSummary[t.serviceName]['Completed']++;
    } else {
      serviceSummary[t.serviceName][t.status]++;
    }
    serviceSummary[t.serviceName]['Total']++;
  });

  // Sort services by total count descending
  const sortedServices = Object.keys(serviceSummary).sort((a, b) => 
    serviceSummary[b]['Total'] - serviceSummary[a]['Total']
  );

  const tokenSummaryBody = document.querySelector('#tokenSummaryTable tbody');
  tokenSummaryBody.innerHTML = '';

  if (sortedServices.length === 0) {
    tokenSummaryBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No transactions found</td></tr>';
    return;
  }

  sortedServices.forEach(service => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${service}</td>
      <td>${serviceSummary[service]['Pending Approval']}</td>
      <td>${serviceSummary[service]['Approved']}</td>
      <td>${serviceSummary[service]['Deficiency']}</td>
      <td>${serviceSummary[service]['Paid']}</td>
      <td>${serviceSummary[service]['Completed']}</td>
      <td>${serviceSummary[service]['Total']}</td>
    `;
    tokenSummaryBody.appendChild(row);
  });
}

function updateServiceFields() {
  const serviceSelect = document.getElementById('serviceSelect');
  const selectedService = serviceSelect.value;

  const customFields = document.getElementById('customServiceFields');
  const customFeeField = document.getElementById('customServiceFieldsFee');
  const ageCaseFields = document.getElementById('ageCaseFields');
  const feeTypeFields = document.getElementById('feeTypeFields');

  customFields.style.display = 'none';
  customFeeField.style.display = 'none';
  ageCaseFields.style.display = 'none';
  feeTypeFields.style.display = 'none';

  if (selectedService === 'Custom') {
    customFields.style.display = 'block';
    customFeeField.style.display = 'block';
    feeTypeFields.style.display = 'block';
  } else if (selectedService === 'AgeCase') {
    ageCaseFields.style.display = 'block';
  } else if (selectedService) {
    feeTypeFields.style.display = 'block';
  }

  calculateTotal();
}

function updateAgeCaseOptions() {
  const ageCaseType = document.querySelector('input[name="ageCaseType"]:checked').value;
  const ageCasePriceSelect = document.getElementById('ageCasePrice');

  if (ageCaseType === 'Executive') {
    document.querySelectorAll('.executive-option').forEach(option => {
      option.style.display = 'block';
    });
    const firstExec = ageCasePriceSelect.querySelector('.executive-option');
    if (firstExec) firstExec.selected = true;
  } else {
    document.querySelectorAll('.executive-option').forEach(option => {
      option.style.display = 'none';
    });
    const firstNormal = ageCasePriceSelect.querySelector('option:not(.executive-option)');
    if (firstNormal) firstNormal.selected = true;
  }

  calculateTotal();
}

function calculateTotal() {
  const serviceSelect = document.getElementById('serviceSelect');
  const selectedService = serviceSelect.value;
  let serviceFee = 0;

  if (selectedService === 'Custom') {
    serviceFee = parseInt(document.getElementById('customServiceFee').value) || 0;
  } else if (selectedService === 'AgeCase') {
    serviceFee = parseInt(document.getElementById('ageCasePrice').value) || 0;
  } else if (selectedService) {
    const feeType = document.getElementById('feeType').value.toLowerCase();
    const feeAttribute = `data-${feeType}`;
    serviceFee = parseInt(serviceSelect.options[serviceSelect.selectedIndex].getAttribute(feeAttribute)) || 0;
  }

  document.getElementById('serviceFee').value = serviceFee;
}
</script>
</body>
</html>
